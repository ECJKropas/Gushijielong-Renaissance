{% extends "base.html" %}

{% block title %}故事树 - {{ root_node.title }}{% endblock %}

{% block content %}
<div class="main-content">
    <h2 style="color: #ff6b6b; margin-bottom: 1.5rem;">故事树: {{ root_node.title }}</h2>
    
    {% if not current_user %}
    <div class="login-prompt">
        <p>登录后可以添加分支</p>
        <a href="/login">去登录</a>
    </div>
    {% endif %}
    
    <h3 style="color: #ff6b6b; margin-top: 2rem; margin-bottom: 1rem;">故事树结构</h3>
    
    <div class="tree-container" style="position: fixed; top: 120px; left: 0; right: 0; bottom: 0; border: none; background-color: rgba(255, 255, 255, 0.9); z-index: 1;">
        <div id="tree-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: grab;">
            <div id="tree-content" style="position: absolute; top: 50px; left: 50px; transform: translate(0, 0); transition: transform 0.1s ease-out;">
                <!-- 连接线层 -->
                <div id="connections-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none;">
                    <!-- 递归渲染连接线 -->
                    {% macro render_connections(node, x, y) %}
                        {% set child_x = x + 400 %}
                        {% set child_y = y %}
                        {% set child_spacing = 200 %}
                        {% for i in range(node.children|length) %}
                            {% set child = node.children[i] %}
                            {% set current_child_y = child_y + (i * child_spacing) %}
                            <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
                                <line x1="{{ x + 300 }}" y1="{{ y + 50 }}" x2="{{ child_x }}" y2="{{ current_child_y + 50 }}" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,5"/>
                            </svg>
                            {{ render_connections(child, child_x, current_child_y) }}
                        {% endfor %}
                    {% endmacro %}
                    {{ render_connections(root_node, 0, 0) }}
                </div>
                
                <!-- 节点层 -->
                <div id="nodes-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;">
                    <!-- 根节点 -->
                    <div class="tree-node root-node" data-node-id="{{ root_node.id }}" style="position: absolute; top: 0; left: 0; width: 300px; padding: 1rem; background-color: #ffd1dc; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 10;">
                        <h4>{{ root_node.title }}</h4>
                        <p><strong>选项:</strong> {{ root_node.option_title }}</p>
                        <div class="node-content" style="margin-top: 0.5rem; padding: 0.5rem; background-color: rgba(255, 255, 255, 0.8); border-radius: 8px;">
                            {{ root_node.content_html|safe }}
                        </div>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #888;">
                            创建于: {{ root_node.created_at }}
                        </p>
                    </div>
                    
                    <!-- 递归渲染子节点 -->
                    {% macro render_node(node, level, x, y) %}
                        {% set child_x = x + 400 %}
                        {% set child_y = y %}
                        {% set child_spacing = 200 %}
                        {% for i in range(node.children|length) %}
                            {% set child = node.children[i] %}
                            {% set current_child_y = child_y + (i * child_spacing) %}
                            <!-- 子节点 -->
                            <div class="tree-node" data-node-id="{{ child.id }}" style="position: absolute; top: {{ current_child_y }}px; left: {{ child_x }}px; width: 300px; padding: 1rem; background-color: #d1ecf1; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 10;">
                                <h4>{{ child.title }}</h4>
                                <p><strong>选项:</strong> {{ child.option_title }}</p>
                                <div class="node-content" style="margin-top: 0.5rem; padding: 0.5rem; background-color: rgba(255, 255, 255, 0.8); border-radius: 8px;">
                                    {{ child.content_html|safe }}
                                </div>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #888;">
                                    创建于: {{ child.created_at }}
                                </p>
                                <a href="/tree/node/{{ child.id }}" style="display: inline-block; margin-top: 1rem; padding: 0.3rem 0.8rem; background-color: #ff9ff3; color: white; text-decoration: none; border-radius: 15px; font-size: 0.9rem; font-weight: bold;">
                                    查看此分支
                                </a>
                            </div>
                            
                            <!-- 递归渲染更深层的子节点 -->
                            {{ render_node(child, level + 1, child_x, current_child_y) }}
                        {% endfor %}
                    {% endmacro %}
                    
                    {{ render_node(root_node, 1, 0, 0) }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 侧边栏 -->
    <div id="sidebar" style="position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background-color: white; box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1); z-index: 100; transition: right 0.3s ease; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="color: #ff6b6b;">添加分支</h3>
            <button id="close-sidebar" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888;">&times;</button>
        </div>
        <form id="sidebar-form">
            <input type="hidden" id="sidebar-parent-id" name="parent_id">
            <div style="margin-bottom: 1.5rem;">
                <label for="sidebar-title" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #ff6b6b;">标题</label>
                <input type="text" id="sidebar-title" name="title" required style="width: 100%; padding: 0.75rem; border: 2px solid #ffeaa7; border-radius: 12px; font-family: inherit; font-size: 1rem;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="sidebar-option-title" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #ff6b6b;">选项标题</label>
                <input type="text" id="sidebar-option-title" name="option_title" required style="width: 100%; padding: 0.75rem; border: 2px solid #ffeaa7; border-radius: 12px; font-family: inherit; font-size: 1rem;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="sidebar-content" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #ff6b6b;">内容（支持Markdown）</label>
                <textarea id="sidebar-content" name="content" rows="5" required style="width: 100%; padding: 0.75rem; border: 2px solid #ffeaa7; border-radius: 12px; font-family: inherit; font-size: 1rem;"></textarea>
            </div>
            <button type="submit" style="background-color: #ff9ff3; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 25px; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: bold; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;">添加</button>
        </form>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 画布拖拽功能
        const canvas = document.getElementById('tree-canvas');
        const treeContent = document.getElementById('tree-content');
        let isDragging = false;
        let startX, startY, startTranslateX, startTranslateY;
        
        // 解析当前transform值
        function getCurrentTransform() {
            const transform = window.getComputedStyle(treeContent).transform;
            if (transform === 'none') {
                return { x: 0, y: 0 };
            }
            const matrix = transform.match(/[-+]?[\d\.]+/g).map(Number);
            return { x: matrix[4], y: matrix[5] };
        }
        
        // 禁用鼠标滚轮
        canvas.addEventListener('wheel', function(e) {
            e.preventDefault();
        });
        
        // 阻止文本选择
        canvas.addEventListener('selectstart', function(e) {
            e.preventDefault();
        });
        
        canvas.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            const currentTransform = getCurrentTransform();
            startTranslateX = currentTransform.x;
            startTranslateY = currentTransform.y;
            canvas.style.cursor = 'grabbing';
        });
        
        canvas.addEventListener('mouseleave', function() {
            isDragging = false;
            canvas.style.cursor = 'grab';
        });
        
        canvas.addEventListener('mouseup', function() {
            isDragging = false;
            canvas.style.cursor = 'grab';
        });
        
        canvas.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            e.preventDefault();
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const newTranslateX = startTranslateX + deltaX;
            const newTranslateY = startTranslateY + deltaY;
            treeContent.style.transform = `translate(${newTranslateX}px, ${newTranslateY}px)`;
        });
        
        // 侧边栏相关元素
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const sidebarForm = document.getElementById('sidebar-form');
        const sidebarParentId = document.getElementById('sidebar-parent-id');
        
        // 监听所有节点的右键点击事件
        const treeNodes = document.querySelectorAll('.tree-node');
        treeNodes.forEach(node => {
            node.addEventListener('contextmenu', function(e) {
                e.preventDefault(); // 阻止默认右键菜单
                
                // 获取节点ID
                const nodeId = this.getAttribute('data-node-id');
                
                // 填充parent_id
                sidebarParentId.value = nodeId;
                
                // 显示侧边栏
                sidebar.style.right = '0';
            });
        });
        
        // 关闭侧边栏
        if (closeSidebarBtn) {
            closeSidebarBtn.addEventListener('click', function() {
                sidebar.style.right = '-400px';
            });
        }
        
        // 处理侧边栏表单提交
        if (sidebarForm) {
            sidebarForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch('/tree/node', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        alert('分支添加成功！');
                        window.location.reload();
                    } else {
                        alert('添加失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('添加失败，请重试');
                });
            });
        }
        

    });
</script>
{% endblock %}
