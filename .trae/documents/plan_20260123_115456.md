# 用户认证系统实现计划

## 1. 数据模型更新

### 1.1 添加User模型
```python
class User:
    def __init__(self, id: int, username: str, email: str, password_hash: str):
        self.id = id
        self.username = username
        self.email = email
        self.password_hash = password_hash
        self.role = "user"  # 默认普通用户
        self.registered_at = datetime.now()
        self.active_count = 0
        self.points = 0
        self.credit = 100.0  # 初始信用分
```

### 1.2 更新现有模型
- Story: 添加author_id字段
- StoryChapter: 添加author_id字段
- ChapterComment: 添加author_id字段
- Discussion: 添加author_id字段
- DiscussionComment: 添加author_id字段

### 1.3 更新数据存储和计数器
```python
data_store = {
    "users": [],
    # 现有存储项...
}

counters = {
    "user": 1,
    # 现有计数器...
}
```

## 2. 认证路由实现

### 2.1 创建auth.py路由文件
```
routers/
└── auth.py  # 新增认证路由
```

### 2.2 实现认证端点
- **GET /register** - 显示注册表单
- **POST /register** - 处理注册请求，使用bcrypt加密密码
- **GET /login** - 显示登录表单
- **POST /login** - 处理登录请求，验证密码
- **GET /logout** - 处理登出请求

## 3. 会话管理

- 使用FastAPI的Cookie进行会话管理
- 实现用户认证中间件，验证用户是否登录
- 在请求上下文中添加当前用户信息

## 4. 模板更新

### 4.1 更新base.html
- 添加登录/注册/登出导航链接
- 显示当前用户信息

### 4.2 新增模板文件
- **register.html** - 注册表单
- **login.html** - 登录表单

### 4.3 更新现有模板
- 将author字符串替换为用户名显示
- 添加用户认证状态检查

## 5. 现有路由更新

### 5.1 更新stories.py
- create_story: 添加用户认证检查
- add_chapter: 使用当前登录用户ID

### 5.2 更新comments.py
- add_chapter_comment: 使用当前登录用户ID

### 5.3 更新discussions.py
- create_discussion: 使用当前登录用户ID
- add_discussion_comment: 使用当前登录用户ID

## 6. 安全性实现

- 使用bcrypt加密存储密码
- 实现CSRF保护
- 验证用户输入
- 实现密码强度检查

## 7. 用户信息管理

- 实现用户信息查看页面
- 实现用户信息更新功能
- 添加积分和信用分管理逻辑

## 8. 权限控制

- 实现基于角色的权限控制
- 区分普通用户和管理员权限

## 技术栈

- FastAPI
- Jinja2模板
- bcrypt密码加密
- Cookie会话管理

## 实现步骤

1. 创建User模型和更新现有模型
2. 实现auth路由和认证功能
3. 添加会话管理中间件
4. 更新模板文件
5. 更新现有路由以使用用户系统
6. 测试认证流程
7. 优化用户体验

这个计划将实现完整的用户注册、登录功能，并将现有功能与用户系统集成，同时实现用户权限、积分和信用分管理。